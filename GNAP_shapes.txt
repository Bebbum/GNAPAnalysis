(comment "CPSA 3.6.9")
(comment "Extracted shapes")

(herald "Grant Negotiation and Authorization Protocol" (limit 5000)
  (comment
    "This protocol allows a piece of software, the client instance, to request delegated authorization to resource servers and to request direct information"))

(comment "CPSA 3.6.9")

(comment "All input read from GNAP.scm")

(comment "Step count limited to 5000")

(defprotocol single_token_simple basic
  (defrole client
    (vars (c as name) (access acess_token data))
    (trace (send (enc c access (ltk c as)))
      (recv (enc acess_token (ltk c as)))
      (send (enc acess_token (ltk c as)))
      (send (enc acess_token (ltk c as)))))
  (defrole authorization_server
    (vars (c as name) (access acess_token data))
    (trace (recv (enc c access (ltk c as)))
      (send (enc acess_token (ltk c as)))
      (recv (enc acess_token (ltk c as)))))
  (defrole resource_server
    (vars (c as name) (acess_token data))
    (trace (recv (enc acess_token (ltk c as))))))

(defskeleton single_token_simple
  (vars (access acess_token data) (c as name))
  (defstrand client 4 (access access) (acess_token acess_token) (c c)
    (as as))
  (non-orig (ltk c as))
  (traces
    ((send (enc c access (ltk c as)))
      (recv (enc acess_token (ltk c as)))
      (send (enc acess_token (ltk c as)))
      (send (enc acess_token (ltk c as)))))
  (label 0)
  (unrealized (0 1))
  (origs)
  (comment "1 in cohort - 1 not yet seen"))

(defskeleton single_token_simple
  (vars (access acess_token data) (c as name))
  (defstrand client 4 (access access) (acess_token acess_token) (c c)
    (as as))
  (defstrand authorization_server 2 (access access)
    (acess_token acess_token) (c c) (as as))
  (precedes ((0 0) (1 0)) ((1 1) (0 1)))
  (non-orig (ltk c as))
  (operation encryption-test (displaced 2 0 client 1)
    (enc c access-0 (ltk c as)) (1 0))
  (traces
    ((send (enc c access (ltk c as)))
      (recv (enc acess_token (ltk c as)))
      (send (enc acess_token (ltk c as)))
      (send (enc acess_token (ltk c as))))
    ((recv (enc c access (ltk c as)))
      (send (enc acess_token (ltk c as)))))
  (label 2)
  (parent 0)
  (unrealized)
  (shape)
  (maps ((0) ((c c) (as as) (access access) (acess_token acess_token))))
  (origs))

(defskeleton single_token_simple
  (vars (access acess_token access-0 data) (c as name))
  (defstrand client 4 (access access) (acess_token acess_token) (c c)
    (as as))
  (defstrand authorization_server 2 (access access-0)
    (acess_token acess_token) (c c) (as as))
  (defstrand client 1 (access access-0) (c c) (as as))
  (precedes ((1 1) (0 1)) ((2 0) (1 0)))
  (non-orig (ltk c as))
  (operation encryption-test (added-strand client 1)
    (enc c access-0 (ltk c as)) (1 0))
  (traces
    ((send (enc c access (ltk c as)))
      (recv (enc acess_token (ltk c as)))
      (send (enc acess_token (ltk c as)))
      (send (enc acess_token (ltk c as))))
    ((recv (enc c access-0 (ltk c as)))
      (send (enc acess_token (ltk c as))))
    ((send (enc c access-0 (ltk c as)))))
  (label 3)
  (parent 0)
  (unrealized)
  (shape)
  (maps ((0) ((c c) (as as) (access access) (acess_token acess_token))))
  (origs))

(comment "Nothing left to do")
